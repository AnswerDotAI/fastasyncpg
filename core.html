<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>fastasyncpg</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-000f0825b9c55ed21d14970d810c14a9.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="fastasyncpg">
<meta property="og:description" content="A simple wrapper for asyncpg">
<meta property="og:site_name" content="fastasyncpg">
<meta name="twitter:title" content="fastasyncpg">
<meta name="twitter:description" content="A simple wrapper for asyncpg">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">fastasyncpg</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./core.html">fastasyncpg</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">fastasyncpg</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">fastasyncpg</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#installation" id="toc-installation" class="nav-link active" data-scroll-target="#installation">Installation</a></li>
  <li><a href="#connecting-with-python" id="toc-connecting-with-python" class="nav-link" data-scroll-target="#connecting-with-python">Connecting with Python</a></li>
  <li><a href="#chinook" id="toc-chinook" class="nav-link" data-scroll-target="#chinook">Chinook</a></li>
  <li><a href="#metadata" id="toc-metadata" class="nav-link" data-scroll-target="#metadata">Metadata</a>
  <ul class="collapse">
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a></li>
  <li><a href="#frecord" id="toc-frecord" class="nav-link" data-scroll-target="#frecord">FRecord</a></li>
  <li><a href="#view_names" id="toc-view_names" class="nav-link" data-scroll-target="#view_names">view_names</a></li>
  <li><a href="#table_names" id="toc-table_names" class="nav-link" data-scroll-target="#table_names">table_names</a></li>
  <li><a href="#columns_info" id="toc-columns_info" class="nav-link" data-scroll-target="#columns_info">columns_info</a></li>
  <li><a href="#pk_cols" id="toc-pk_cols" class="nav-link" data-scroll-target="#pk_cols">pk_cols</a></li>
  <li><a href="#database" id="toc-database" class="nav-link" data-scroll-target="#database">Database</a></li>
  <li><a href="#table" id="toc-table" class="nav-link" data-scroll-target="#table">Table</a></li>
  <li><a href="#table.c" id="toc-table.c" class="nav-link" data-scroll-target="#table.c">Table.c</a></li>
  </ul></li>
  <li><a href="#queries-and-views" id="toc-queries-and-views" class="nav-link" data-scroll-target="#queries-and-views">Queries and views</a>
  <ul class="collapse">
  <li><a href="#conv_placeholders" id="toc-conv_placeholders" class="nav-link" data-scroll-target="#conv_placeholders">conv_placeholders</a></li>
  <li><a href="#database.q" id="toc-database.q" class="nav-link" data-scroll-target="#database.q">Database.q</a></li>
  </ul></li>
  <li><a href="#dataclasses" id="toc-dataclasses" class="nav-link" data-scroll-target="#dataclasses">Dataclasses</a>
  <ul class="collapse">
  <li><a href="#get_typ" id="toc-get_typ" class="nav-link" data-scroll-target="#get_typ">get_typ</a></li>
  <li><a href="#setup_json" id="toc-setup_json" class="nav-link" data-scroll-target="#setup_json">setup_json</a></li>
  <li><a href="#connect" id="toc-connect" class="nav-link" data-scroll-target="#connect">connect</a></li>
  <li><a href="#all_dcs" id="toc-all_dcs" class="nav-link" data-scroll-target="#all_dcs">all_dcs</a></li>
  </ul></li>
  <li><a href="#get" id="toc-get" class="nav-link" data-scroll-target="#get">get</a>
  <ul class="collapse">
  <li><a href="#table.__getitem__" id="toc-table.__getitem__" class="nav-link" data-scroll-target="#table.__getitem__">Table.__getitem__</a></li>
  <li><a href="#notfounderror" id="toc-notfounderror" class="nav-link" data-scroll-target="#notfounderror">NotFoundError</a></li>
  <li><a href="#table.get" id="toc-table.get" class="nav-link" data-scroll-target="#table.get">Table.get</a></li>
  </ul></li>
  <li><a href="#callselect" id="toc-callselect" class="nav-link" data-scroll-target="#callselect">call/select</a>
  <ul class="collapse">
  <li><a href="#table.rows_where" id="toc-table.rows_where" class="nav-link" data-scroll-target="#table.rows_where">Table.rows_where</a></li>
  <li><a href="#table.count_where" id="toc-table.count_where" class="nav-link" data-scroll-target="#table.count_where">Table.count_where</a></li>
  <li><a href="#table.count" id="toc-table.count" class="nav-link" data-scroll-target="#table.count">Table.count</a></li>
  <li><a href="#get_field" id="toc-get_field" class="nav-link" data-scroll-target="#get_field">get_field</a></li>
  <li><a href="#table.pks_and_rows_where" id="toc-table.pks_and_rows_where" class="nav-link" data-scroll-target="#table.pks_and_rows_where">Table.pks_and_rows_where</a></li>
  <li><a href="#table.__call__" id="toc-table.__call__" class="nav-link" data-scroll-target="#table.__call__">Table.__call__</a></li>
  <li><a href="#table.selectone" id="toc-table.selectone" class="nav-link" data-scroll-target="#table.selectone">Table.selectone</a></li>
  <li><a href="#database.item" id="toc-database.item" class="nav-link" data-scroll-target="#database.item">Database.item</a></li>
  </ul></li>
  <li><a href="#create_mod" id="toc-create_mod" class="nav-link" data-scroll-target="#create_mod">create_mod</a>
  <ul class="collapse">
  <li><a href="#create_mod-1" id="toc-create_mod-1" class="nav-link" data-scroll-target="#create_mod-1">create_mod</a></li>
  <li><a href="#database.link_dcs" id="toc-database.link_dcs" class="nav-link" data-scroll-target="#database.link_dcs">Database.link_dcs</a></li>
  <li><a href="#database.set_classes" id="toc-database.set_classes" class="nav-link" data-scroll-target="#database.set_classes">Database.set_classes</a></li>
  <li><a href="#database.get_tables" id="toc-database.get_tables" class="nav-link" data-scroll-target="#database.get_tables">Database.get_tables</a></li>
  </ul></li>
  <li><a href="#insert" id="toc-insert" class="nav-link" data-scroll-target="#insert">insert</a>
  <ul class="collapse">
  <li><a href="#table.insert" id="toc-table.insert" class="nav-link" data-scroll-target="#table.insert">Table.insert</a></li>
  <li><a href="#database.table2glb" id="toc-database.table2glb" class="nav-link" data-scroll-target="#database.table2glb">Database.table2glb</a></li>
  </ul></li>
  <li><a href="#update" id="toc-update" class="nav-link" data-scroll-target="#update">update</a>
  <ul class="collapse">
  <li><a href="#table.update" id="toc-table.update" class="nav-link" data-scroll-target="#table.update">Table.update</a></li>
  </ul></li>
  <li><a href="#delete" id="toc-delete" class="nav-link" data-scroll-target="#delete">delete</a>
  <ul class="collapse">
  <li><a href="#table.delete" id="toc-table.delete" class="nav-link" data-scroll-target="#table.delete">Table.delete</a></li>
  <li><a href="#table.delete_where" id="toc-table.delete_where" class="nav-link" data-scroll-target="#table.delete_where">Table.delete_where</a></li>
  </ul></li>
  <li><a href="#create" id="toc-create" class="nav-link" data-scroll-target="#create">Create</a>
  <ul class="collapse">
  <li><a href="#col_def" id="toc-col_def" class="nav-link" data-scroll-target="#col_def">col_def</a></li>
  <li><a href="#database.create" id="toc-database.create" class="nav-link" data-scroll-target="#database.create">Database.create</a></li>
  <li><a href="#table.drop" id="toc-table.drop" class="nav-link" data-scroll-target="#table.drop">Table.drop</a></li>
  </ul></li>
  <li><a href="#upsert" id="toc-upsert" class="nav-link" data-scroll-target="#upsert">Upsert</a>
  <ul class="collapse">
  <li><a href="#table.upsert" id="toc-table.upsert" class="nav-link" data-scroll-target="#table.upsert">Table.upsert</a></li>
  </ul></li>
  <li><a href="#connection-pool" id="toc-connection-pool" class="nav-link" data-scroll-target="#connection-pool">Connection pool</a>
  <ul class="collapse">
  <li><a href="#create_pool" id="toc-create_pool" class="nav-link" data-scroll-target="#create_pool">create_pool</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/AnswerDotAI/fastasyncpg/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="core.html.md"><i class="bi bi-file-code"></i>CommonMark</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">fastasyncpg</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p><code>fastasyncpg</code> is a simple wrapper for asyncpg. We’ll explain how it works and build up the module in a “literate” nbdev style.</p>
<section id="installation" class="level2">
<h2 class="anchored" data-anchor-id="installation">Installation</h2>
<p>On macOS, the recommended way to install PostgreSQL is via <strong>Homebrew</strong>. Other options include Postgres.app (a menubar app) and the EDB installer, but Homebrew integrates best with command-line workflows and makes updates simple.</p>
<p>To install PostgreSQL 18 (the current latest stable release):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">brew</span> install postgresql@18</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>To check if you already have PostgreSQL installed via Homebrew, run <code>brew list | grep postgres</code>. You can also check which version is in your PATH with <code>psql --version</code>.</p>
<p>Let’s verify the installation is working:</p>
<div id="66516e0d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>brew <span class="bu">list</span> <span class="op">|</span> grep postgres</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>postgresql@18</code></pre>
</div>
</div>
<div id="fb607a22" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>psql <span class="op">--</span>version</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>psql (PostgreSQL) 18.1 (Homebrew)</code></pre>
</div>
</div>
<p>After installation, run <code>brew info postgresql@18</code> to see setup instructions. PostgreSQL 18 is “keg-only”, meaning it’s not automatically symlinked into your PATH.</p>
<p>You’ll see something like:</p>
<pre><code>This formula has created a default database cluster with:
  initdb --locale=en_US.UTF-8 -E UTF-8 /opt/homebrew/var/postgresql@18

When uninstalling, some dead symlinks are left behind so you may want to run:
  brew cleanup --prune-prefix

postgresql@18 is keg-only, which means it was not symlinked into /opt/homebrew,
because this is an alternate version of another formula.

If you need to have postgresql@18 first in your PATH, run:
  echo 'export PATH="/opt/homebrew/opt/postgresql@18/bin:$PATH"' &gt;&gt; /Users/jhoward/.bash_profile

To start postgresql@18 now and restart at login:
  brew services start postgresql@18</code></pre>
<p>The <code>brew info</code> output (above) tells you exactly what to do:</p>
<ol type="1">
<li><strong>Add to PATH</strong> (for bash): <code>echo 'export PATH="/opt/homebrew/opt/postgresql@18/bin:$PATH"' &gt;&gt; ~/.bash_profile &amp;&amp; source ~/.bash_profile</code></li>
<li><strong>Start the service</strong>: <code>brew services start postgresql@18</code></li>
</ol>
<p>This registers PostgreSQL to start automatically at login.</p>
<p>To run non-interactive queries from a shell, use <code>-c</code> to pass a command directly:</p>
<div id="df0063d9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>psql <span class="op">-</span>d postgres <span class="op">-</span>c <span class="st">"SELECT version();"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                           version                                                           
-----------------------------------------------------------------------------------------------------------------------------
 PostgreSQL 18.1 (Homebrew) on aarch64-apple-darwin25.2.0, compiled by Apple clang version 17.0.0 (clang-1700.6.3.2), 64-bit
(1 row)
</code></pre>
</div>
</div>
<p>Running <code>brew services start</code> registers PostgreSQL to start automatically at login/reboot. You can verify this with <code>brew services list</code>, which shows all Homebrew-managed services and their status.</p>
<div id="d70d52ad" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>brew services <span class="bu">list</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Name          Status  User    File
cloudflared   none            
postgresql@18 started jhoward ~/Library/LaunchAgents/homebrew.mxcl.postgresql@18.plist
unbound       none            </code></pre>
</div>
</div>
<p>To control auto-start behavior: - <code>brew services stop postgresql@18</code> — stop and disable auto-start - <code>brew services start postgresql@18</code> — start and enable auto-start<br>
- <code>brew services run postgresql@18</code> — run once without enabling auto-start</p>
<p>On Ubuntu, the standard way to get the latest PostgreSQL is through the <strong>official PostgreSQL APT repository</strong> (PGDG), since Ubuntu’s default repos often have older versions.</p>
</section>
<section id="connecting-with-python" class="level2">
<h2 class="anchored" data-anchor-id="connecting-with-python">Connecting with Python</h2>
<p>The most popular Python libraries for PostgreSQL are <strong>psycopg2/psycopg3</strong> (synchronous) and <strong>asyncpg</strong> (async). For async work, asyncpg is about 5x faster than psycopg3 and is the recommended choice.</p>
<p>We’ll use <strong>asyncpg</strong> for this wrapper — it’s the fastest Python PostgreSQL library for async code.</p>
<div id="68ede6e6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="c38724db" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>user <span class="op">=</span> os.environ[<span class="st">'USER'</span>]<span class="op">;</span> user</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'jhoward'</code></pre>
</div>
</div>
<p>asyncpg uses <code>await</code> for all database operations. The <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#connect"><code>connect</code></a> function returns a connection object, and <code>fetchval</code> is a convenience method that returns a single value from the first row:</p>
<div id="edb146d8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>conn <span class="op">=</span> <span class="cf">await</span> asyncpg.<span class="ex">connect</span>(user<span class="op">=</span>user, database<span class="op">=</span><span class="st">'postgres'</span>, host<span class="op">=</span><span class="st">'127.0.0.1'</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> conn.fetchval(<span class="st">'SELECT version()'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'PostgreSQL 18.1 (Homebrew) on aarch64-apple-darwin25.2.0, compiled by Apple clang version 17.0.0 (clang-1700.6.3.2), 64-bit'</code></pre>
</div>
</div>
<p>Let’s create a simple test table to explore basic operations:</p>
<div id="82347755" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> conn.execute(<span class="st">'''DROP TABLE IF EXISTS users'''</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> conn.execute(<span class="st">'''CREATE TABLE users ( id SERIAL PRIMARY KEY, name TEXT NOT NULL, age INTEGER )'''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'CREATE TABLE'</code></pre>
</div>
</div>
<p>Great! Now let’s insert some data:</p>
<div id="cd7585b9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> conn.execute(<span class="st">"INSERT INTO users (name, age) VALUES ($1, $2)"</span>, <span class="st">'Alice'</span>, <span class="dv">30</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'INSERT 0 1'</code></pre>
</div>
</div>
<p>PostgreSQL uses <code>$1</code>, <code>$2</code>, etc. for parameterized queries, not <code>?</code> like SQLite. This syntax allows you to reference the same parameter multiple times and makes the order explicit.</p>
<p><code>fetch</code> returns a list of <code>Record</code> objects. Each record supports dict-like access by column name or index:</p>
<div id="db331ef8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>rs <span class="op">=</span> <span class="cf">await</span> conn.fetch(<span class="st">"SELECT * FROM users"</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>rs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[&lt;Record id=1 name='Alice' age=30&gt;]</code></pre>
</div>
</div>
<div id="60b1d412" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> rs[<span class="dv">0</span>]</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(rs),<span class="bu">type</span>(r)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>(list, asyncpg.protocol.record.Record)</code></pre>
</div>
</div>
<p><code>asyncpg.Record</code> objects use dict-like access (<code>r['name']</code> or <code>r[0]</code>), not attribute access. You can use <code>dict2obj</code> if you want the latter.</p>
<div id="4aead35c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>ro <span class="op">=</span> dict2obj(<span class="bu">dict</span>(r))</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>ro.name</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'Alice'</code></pre>
</div>
</div>
<p>Unlike psycopg2, asyncpg doesn’t use traditional cursors. Instead, use <code>async for record in conn.cursor(...)</code> to iterate over results. However, cursors in asyncpg require an explicit transaction:</p>
<div id="e14d9dca" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># raises "NoActiveSQLTransactionError: cursor cannot be created outside of a transaction"</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># async for record in conn.cursor("SELECT * FROM users"): print(record)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="26d46d3e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="cf">with</span> conn.transaction():</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">for</span> record <span class="kw">in</span> conn.cursor(<span class="st">"SELECT * FROM users"</span>): <span class="bu">print</span>(record)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;Record id=1 name='Alice' age=30&gt;</code></pre>
</div>
</div>
<p>By default, asyncpg operates in <strong>auto-commit mode</strong> — changes are applied immediately when not in an explicit transaction block. Regular queries (<code>execute</code>, <code>fetch</code>, etc.) don’t need transactions, but cursors do. This is a direct reflection of how PostgreSQL itself handles “portals” (the underlying mechanism for cursors).</p>
<p>In PostgreSQL, a portal is generally only valid for the duration of a transaction. If a transaction isn’t explicitly started, PostgreSQL runs each command in its own “one-shot” transaction. For a cursor to stay open so you can fetch multiple batches of rows, the transaction it belongs to must remain open.</p>
<p>Other libraries (like <code>psycopg2</code>) often hide this by starting a transaction for you automatically when you create a cursor, whereas <code>asyncpg</code> chooses to be more “explicit” about the underlying database state.</p>
</section>
<section id="chinook" class="level2">
<h2 class="anchored" data-anchor-id="chinook">Chinook</h2>
<p>For testing with a real dataset, we’ll use the <strong>Chinook</strong> sample database, which has tables for artists, albums, tracks, etc. The PostgreSQL version is available on GitHub:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-L</span> <span class="at">-O</span> https://github.com/lerocha/chinook-database/raw/master/ChinookDatabase/DataSources/Chinook_PostgreSql.sql</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Now we need to create a database and run that script. First, let’s create a database called <code>chinook</code>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ex">createdb</span> chinook</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Then we can load the SQL file into it:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-d</span> chinook <span class="at">-f</span> Chinook_PostgreSql.sql</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Always close connections when done — this releases the database connection back to PostgreSQL:</p>
<div id="8005ee76" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> conn.close()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now let’s connect to the Chinook database to work with more realistic data:</p>
<div id="35863303" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>conn <span class="op">=</span> <span class="cf">await</span> asyncpg.<span class="ex">connect</span>(user<span class="op">=</span>user, database<span class="op">=</span><span class="st">'chinook'</span>, host<span class="op">=</span><span class="st">'127.0.0.1'</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> conn.fetchval(<span class="st">"SELECT count(*) FROM artist"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>275</code></pre>
</div>
</div>
</section>
<section id="metadata" class="level2">
<h2 class="anchored" data-anchor-id="metadata">Metadata</h2>
<p><a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#results"><code>Results</code></a> is a simple list subclass that renders as an HTML table in notebooks. It displays all rows with column headers, making query results easy to read:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L14" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="results" class="level3">
<h3 class="anchored" data-anchor-id="results">Results</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> Results(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Built-in mutable sequence.</em></p>
<p>If no argument is given, the constructor creates a new empty list. The argument must be an iterable if specified.</p>
<p><code>sql</code> is a quick helper to run SQL and return results as a list of records:</p>
<div id="9f4c4cc8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.core.magic <span class="im">import</span> register_cell_magic</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="081a6d78" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="at">@register_cell_magic</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> sql(l,c): <span class="cf">return</span> Results(<span class="cf">await</span> conn.fetch(c))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="d9190723" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>SELECT column_name, data_type, is_nullable</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>FROM information_schema.columns</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>WHERE table_name <span class="op">=</span> <span class="st">'artist'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<table class="prose caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">column_name</th>
<th data-quarto-table-cell-role="th">data_type</th>
<th data-quarto-table-cell-role="th">is_nullable</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>artist_id</td>
<td>integer</td>
<td>NO</td>
</tr>
<tr class="even">
<td>name</td>
<td>character varying</td>
<td>YES</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>In PostgreSQL, every table belongs to a <strong>schema</strong> — think of it as a folder or namespace. The default schema is <code>public</code>. When you create a table without specifying a schema, it lands there. You can query schema information via <code>information_schema</code> views:</p>
<div id="246560ef" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>SELECT column_name, data_type, is_nullable</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>FROM information_schema.columns</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>WHERE table_name <span class="op">=</span> <span class="st">'artist'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<table class="prose caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">column_name</th>
<th data-quarto-table-cell-role="th">data_type</th>
<th data-quarto-table-cell-role="th">is_nullable</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>artist_id</td>
<td>integer</td>
<td>NO</td>
</tr>
<tr class="even">
<td>name</td>
<td>character varying</td>
<td>YES</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>To list all tables in the <code>public</code> schema, you can query the <code>information_schema.tables</code> view:</p>
<div id="ad08081d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> conn.fetch(<span class="st">"SELECT table_name FROM information_schema.tables WHERE table_schema = 'public'"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[&lt;Record table_name='artist'&gt;,
 &lt;Record table_name='album'&gt;,
 &lt;Record table_name='employee'&gt;,
 &lt;Record table_name='customer'&gt;,
 &lt;Record table_name='invoice'&gt;,
 &lt;Record table_name='invoice_line'&gt;,
 &lt;Record table_name='track'&gt;,
 &lt;Record table_name='playlist'&gt;,
 &lt;Record table_name='playlist_track'&gt;,
 &lt;Record table_name='genre'&gt;,
 &lt;Record table_name='media_type'&gt;,
 &lt;Record table_name='cats'&gt;,
 &lt;Record table_name='cat'&gt;,
 &lt;Record table_name='dog'&gt;]</code></pre>
</div>
</div>
<p>To customize how records behave, we need access to the underlying <code>Record</code> class:</p>
<p><a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#frecord"><code>FRecord</code></a> extends asyncpg’s <code>Record</code> with two conveniences: attribute access (<code>r.name</code> instead of <code>r['name']</code>) and HTML rendering for notebooks:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L26" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="frecord" class="level3">
<h3 class="anchored" data-anchor-id="frecord">FRecord</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> FRecord(</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Initialize self. See help(type(self)) for accurate signature.</em></p>
<p>We can use <code>record_class</code> to auto-wrap with <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#frecord"><code>FRecord</code></a>:</p>
<div id="95964ec3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> conn.close()</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>conn <span class="op">=</span> <span class="cf">await</span> asyncpg.<span class="ex">connect</span>(user<span class="op">=</span>user, database<span class="op">=</span><span class="st">'chinook'</span>, host<span class="op">=</span><span class="st">'127.0.0.1'</span>, record_class<span class="op">=</span>FRecord)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#table_names"><code>table_names</code></a> and <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#view_names"><code>view_names</code></a> query PostgreSQL’s system catalogs to list tables and views in a schema. We use <code>pg_class</code> and <code>pg_namespace</code> rather than <code>information_schema</code> for better performance:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L44" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="view_names" class="level3">
<h3 class="anchored" data-anchor-id="view_names">view_names</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> view_names(</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    conn, schema:<span class="bu">str</span><span class="op">=</span><span class="st">'public'</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>List of view names in <code>schema</code></em></p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L36" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="table_names" class="level3">
<h3 class="anchored" data-anchor-id="table_names">table_names</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> table_names(</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    conn, schema:<span class="bu">str</span><span class="op">=</span><span class="st">'public'</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>List of table names in <code>schema</code></em></p>
<div id="6046cc78" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">' '</span>.join(<span class="cf">await</span> table_names(conn)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>artist album employee customer invoice invoice_line track playlist playlist_track genre media_type cats cat dog</code></pre>
</div>
</div>
<div id="7b5a5705" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> view_names(conn)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[]</code></pre>
</div>
</div>
<p><a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#columns_info"><code>columns_info</code></a> returns a dict mapping column names to their PostgreSQL data types. It queries <code>pg_attribute</code> directly for efficiency:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L53" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="columns_info" class="level3">
<h3 class="anchored" data-anchor-id="columns_info">columns_info</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> columns_info(</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    conn, table, schema:<span class="bu">str</span><span class="op">=</span><span class="st">'public'</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Dict mapping column names to data types for <code>table</code></em></p>
<div id="91b10d5d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(<span class="cf">await</span> columns_info(conn, <span class="st">'artist'</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>['artist_id', 'name']</code></pre>
</div>
</div>
<p>We’ll need to know each table’s primary key. PostgreSQL stores this in <code>pg_index</code>. The <code>::regclass</code> cast is idiomatic PostgreSQL — it converts a table name string to its internal object ID, automatically handling schema resolution. The <code>indisprimary</code> flag identifies the primary key index.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L65" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="pk_cols" class="level3">
<h3 class="anchored" data-anchor-id="pk_cols">pk_cols</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pk_cols(</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    conn, table</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Get primary key column(s) for <code>table</code></em></p>
<div id="a2d0f75f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> pk_cols(conn, <span class="st">'artist'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>['artist_id']</code></pre>
</div>
</div>
<p><a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#database"><code>Database</code></a> wraps an asyncpg connection (or pool) and provides table/view metadata caching. It delegates unknown attributes to the underlying connection via <code>__getattr__</code>, so you can call <code>db.fetch(...)</code> directly. The <code>t</code> property returns a <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#_tablesgetter"><code>_TablesGetter</code></a> for convenient table access.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L74" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="database" class="level3">
<h3 class="anchored" data-anchor-id="database">Database</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> Database(</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    conn, refresh:<span class="bu">bool</span><span class="op">=</span><span class="va">True</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Initialize self. See help(type(self)) for accurate signature.</em></p>
<p><a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#table"><code>Table</code></a> represents a database table with metadata like columns and primary keys. The <code>xtra</code> method lets you set persistent row filters (useful for multi-tenancy). Tables stringify as quoted identifiers for safe SQL interpolation.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L109" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="table" class="level3">
<h3 class="anchored" data-anchor-id="table">Table</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> Table(</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    db, name</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Initialize self. See help(type(self)) for accurate signature.</em></p>
<p><a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#_getter"><code>_Getter</code></a> is a base class for “magic accessor” objects that provide multiple ways to access items — by attribute (<code>dt.artist</code>), by index (<code>dt['artist']</code>), or by iteration (<code>for t in dt</code>). It implements <code>__dir__</code> so tab-completion works in notebooks, <code>__repr__</code> for nice display, <code>__contains__</code> for <code>in</code> checks, and both <code>__getattr__</code> and <code>__getitem__</code> for flexible access.</p>
<p><a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#_tablesgetter"><code>_TablesGetter</code></a> specializes this for tables, reading from the database’s <code>_tnames</code> list. The <code>db.t</code> property returns one of these, giving you a clean API: <code>db.t.artist</code> instead of <code>db.table('artist')</code>.</p>
<p><a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#connect"><code>connect</code></a> is our main entry point — it creates an asyncpg connection with <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#frecord"><code>FRecord</code></a> as the default record class, sets up JSON codecs, and returns a <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#database"><code>Database</code></a> wrapper with metadata already loaded:</p>
<div id="78cceb21" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> <span class="ex">connect</span>(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    kwargs.setdefault(<span class="st">'record_class'</span>, FRecord)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    conn <span class="op">=</span> <span class="cf">await</span> asyncpg.<span class="ex">connect</span>(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> Database(conn, refresh<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> res.refresh()</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="c78235ae" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> conn.close()</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> <span class="cf">await</span> <span class="ex">connect</span>(user<span class="op">=</span>user, database<span class="op">=</span><span class="st">'chinook'</span>, host<span class="op">=</span><span class="st">'127.0.0.1'</span>)<span class="op">;</span> <span class="bu">str</span>(db)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'postgresql://jhoward@127.0.0.1:5432/chinook'</code></pre>
</div>
</div>
<div id="3684bb5d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>dt <span class="op">=</span> db.t</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>artist <span class="op">=</span> dt.artist</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>artist</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Table "artist"</code></pre>
</div>
</div>
<div id="835200a1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>artist.pks</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>['artist_id']</code></pre>
</div>
</div>
<div id="fc498b7a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>dt[<span class="st">'album'</span>,<span class="st">'artist'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[Table "album", Table "artist"]</code></pre>
</div>
</div>
<div id="56df24eb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> tbl <span class="kw">in</span> dt:</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tbl.name[<span class="dv">0</span>]<span class="op">==</span><span class="st">'a'</span>: <span class="bu">print</span>(tbl)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>"album"
"artist"</code></pre>
</div>
</div>
<div id="850cdd9e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="st">'artist'</span> <span class="kw">in</span> dt</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> artist <span class="kw">in</span> dt</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="st">'foo'</span> <span class="kw">not</span> <span class="kw">in</span> dt</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="1a7cd37d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>artist.cols</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'artist_id': 'integer', 'name': 'character varying(120)'}</code></pre>
</div>
</div>
<p><a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#_col"><code>_Col</code></a> represents a single column, with <code>__str__</code> returning fully-qualified SQL (<code>"table"."column"</code>). <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#_colsgetter"><code>_ColsGetter</code></a> follows the same pattern as <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#_tablesgetter"><code>_TablesGetter</code></a> — it’s a magic accessor that lets you write <code>artist.c.name</code> to get a column reference. The <code>__call__</code> method returns all columns as <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#_col"><code>_Col</code></a> objects, useful for building queries programmatically.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L163" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="table.c" class="level3">
<h3 class="anchored" data-anchor-id="table.c">Table.c</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> c(</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="9f8f29cd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>ac <span class="op">=</span> artist.c</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>ac</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>artist_id, name</code></pre>
</div>
</div>
<p>Columns stringify in a format suitable for including in SQL statements.</p>
<div id="3d620143" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"select </span><span class="sc">{</span>ac<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> ..."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>select "artist"."name" ...</code></pre>
</div>
</div>
<p>Tables and views do the same.</p>
<div id="3a21d318" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"select </span><span class="sc">{</span>ac<span class="sc">.</span>Name<span class="sc">}</span><span class="ss"> from </span><span class="sc">{</span>artist<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>select "artist"."Name" from "artist"</code></pre>
</div>
</div>
<div id="a9c464a5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="st">'name'</span> <span class="kw">in</span> ac</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> ac.name <span class="kw">in</span> ac</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="st">'foo'</span> <span class="kw">not</span> <span class="kw">in</span> ac</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="queries-and-views" class="level2">
<h2 class="anchored" data-anchor-id="queries-and-views">Queries and views</h2>
<p>We will support <code>?</code> in addition to the standard pgsql <code>$1</code> form placeholders, by using <code>sqlparse</code> to parse the query.</p>
<p><code>sqlparse</code> returns a token list per statement, eg:</p>
<div id="4637ee29" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>ts <span class="op">=</span> sqlparse.parse(<span class="st">"SELECT * FROM artist WHERE artist_id = ?"</span>)[<span class="dv">0</span>].flatten()</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> ts: <span class="bu">print</span>(<span class="bu">repr</span>(t.ttype), <span class="bu">repr</span>(t.value))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Token.Keyword.DML 'SELECT'
Token.Text.Whitespace ' '
Token.Wildcard '*'
Token.Text.Whitespace ' '
Token.Keyword 'FROM'
Token.Text.Whitespace ' '
Token.Name 'artist'
Token.Text.Whitespace ' '
Token.Keyword 'WHERE'
Token.Text.Whitespace ' '
Token.Name 'artist_id'
Token.Text.Whitespace ' '
Token.Operator.Comparison '='
Token.Text.Whitespace ' '
Token.Name.Placeholder '?'</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L177" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="conv_placeholders" class="level3">
<h3 class="anchored" data-anchor-id="conv_placeholders">conv_placeholders</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> conv_placeholders(</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    sql, kwargs:VAR_KEYWORD</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Convert <code>?</code> and <code>:name</code> placeholders to PostgreSQL <code>$n</code> style</em></p>
<div id="a515f26c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(conv_placeholders(<span class="st">"""</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT * FROM a WHERE id = ?;</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT * FROM b WHERE name = ?</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>)[<span class="dv">0</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    SELECT * FROM a WHERE id = $1;
    SELECT * FROM b WHERE name = $2
</code></pre>
</div>
</div>
<div id="d00d7740" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>conv_placeholders(<span class="st">"SELECT * FROM artist WHERE artist_id = $1 AND name = ?"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>('SELECT * FROM artist WHERE artist_id = $1 AND name = $1', [])</code></pre>
</div>
</div>
<p>We get back values for the kwargs in the order they appear:</p>
<div id="dd56116a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>conv_placeholders(<span class="st">"SELECT * FROM artist WHERE artist_id = :id AND name = :name"</span>, <span class="bu">id</span><span class="op">=</span><span class="dv">5</span>, name<span class="op">=</span><span class="st">'AC/DC'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>('SELECT * FROM artist WHERE artist_id = $1 AND name = $2', [5, 'AC/DC'])</code></pre>
</div>
</div>
<p>A repeated kw placeholder name results in a single arg result:</p>
<div id="bb4c27f8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>conv_placeholders(<span class="st">"SELECT * FROM a WHERE id = :uid OR creator = :uid"</span>, uid<span class="op">=</span><span class="dv">42</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>('SELECT * FROM a WHERE id = $1 OR creator = $1', [42])</code></pre>
</div>
</div>
<p>Placeholder types can be mixed:</p>
<div id="83813410" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>conv_placeholders(<span class="st">"SELECT * FROM a WHERE id = ? AND name = :name and foo=?"</span>, name<span class="op">=</span><span class="st">'test'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>('SELECT * FROM a WHERE id = $1 AND name = $3 and foo=$2', ['test'])</code></pre>
</div>
</div>
<p><code>db.q</code> is a convenience method that runs a SQL query and wraps results in a <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#results"><code>Results</code></a> list for nice HTML rendering:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L196" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="database.q" class="level3">
<h3 class="anchored" data-anchor-id="database.q">Database.q</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> q(</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    sql, args:VAR_POSITIONAL, kwargs:VAR_KEYWORD</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="13beff3b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>acdc <span class="op">=</span> <span class="cf">await</span> db.q(<span class="ss">f"select * from </span><span class="sc">{</span>artist<span class="sc">}</span><span class="ss"> where </span><span class="sc">{</span>ac<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> like 'AC/%'"</span>)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>acdc</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<table class="prose caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">artist_id</th>
<th data-quarto-table-cell-role="th">name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>AC/DC</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="8ffdea2c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> db.q(<span class="ss">f"select * from </span><span class="sc">{</span>artist<span class="sc">}</span><span class="ss"> where </span><span class="sc">{</span>ac<span class="sc">.</span>name<span class="sc">}</span><span class="ss">=$1"</span>, <span class="st">'AC/DC'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<table class="prose caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">artist_id</th>
<th data-quarto-table-cell-role="th">name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>AC/DC</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="81056d68" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> db.q(<span class="ss">f"select * from </span><span class="sc">{</span>artist<span class="sc">}</span><span class="ss"> where </span><span class="sc">{</span>ac<span class="sc">.</span>name<span class="sc">}</span><span class="ss">=?"</span>, <span class="st">'AC/DC'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<table class="prose caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">artist_id</th>
<th data-quarto-table-cell-role="th">name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>AC/DC</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="368bf975" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> db.q(<span class="ss">f"select * from </span><span class="sc">{</span>artist<span class="sc">}</span><span class="ss"> where </span><span class="sc">{</span>ac<span class="sc">.</span>name<span class="sc">}</span><span class="ss">=:name"</span>, name<span class="op">=</span><span class="st">'AC/DC'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<table class="prose caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">artist_id</th>
<th data-quarto-table-cell-role="th">name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>AC/DC</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="dataclasses" class="level2">
<h2 class="anchored" data-anchor-id="dataclasses">Dataclasses</h2>
<p>PostgreSQL has many data types that map to Python equivalents. We’ll import the Python types we need:</p>
<p><a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#get_typ"><code>get_typ</code></a> extracts the base PostgreSQL type (stripping size specifiers like <code>(120)</code>) and maps it to the corresponding Python type:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L208" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="get_typ" class="level3">
<h3 class="anchored" data-anchor-id="get_typ">get_typ</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_typ(</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>    pg_type</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Get Python type for PostgreSQL type string</em></p>
<p>The <code>pg_to_py</code> dict maps PostgreSQL type names to Python types. This covers the most common types — numeric, string, temporal, JSON, network, and geometric:</p>
<p>asyncpg doesn’t automatically decode JSON columns — we need to register custom codecs. The <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#setup_json"><code>setup_json</code></a> function configures both <code>json</code> and <code>jsonb</code> types to use Python’s <code>json</code> module:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L247" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="setup_json" class="level3">
<h3 class="anchored" data-anchor-id="setup_json">setup_json</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_json(</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>    conn</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>We’ll re-define <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#connect"><code>connect</code></a> to use json now:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L252" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="connect" class="level3">
<h3 class="anchored" data-anchor-id="connect">connect</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="ex">connect</span>(</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="4a86087b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> db.close()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="d01ae26b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> <span class="cf">await</span> <span class="ex">connect</span>(user<span class="op">=</span>user, database<span class="op">=</span><span class="st">'chinook'</span>, host<span class="op">=</span><span class="st">'127.0.0.1'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We’ll use Python’s <code>dataclasses</code> module to auto-generate typed classes from table schemas:</p>
<p>With the type mapping in place, we can auto-generate Python dataclasses from table schemas. The <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#_get_flds"><code>_get_flds</code></a> helper extracts field definitions, and <code>dataclass()</code> creates a dataclass matching the table structure. We use <code>flexiclass</code> from fastcore to make the dataclass more flexible (allowing partial instantiation).</p>
<div id="39c1ed7f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>dt <span class="op">=</span> db.t</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>artist <span class="op">=</span> dt.artist</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>Artist <span class="op">=</span> artist.dataclass()</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>art1_obj <span class="op">=</span> Artist(<span class="op">**</span>acdc[<span class="dv">0</span>])</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>art1_obj</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Artist(artist_id=1, name='AC/DC')</code></pre>
</div>
</div>
<div id="b863927a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>artist.cls</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>__main__.Artist</code></pre>
</div>
</div>
<p>You can get the definition of the dataclass using fastcore’s <code>dataclass_src</code>:</p>
<div id="f50f7c4e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>src <span class="op">=</span> dataclass_src(Artist)</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>hl_md(src, <span class="st">'python'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Artist:</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>    artist_id: <span class="bu">int</span> <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> UNSET</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span> <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> UNSET</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p><a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#all_dcs"><code>all_dcs</code></a> generates dataclasses for every table (and optionally views) in the database. This is useful for type-checking and IDE autocompletion:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L278" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="all_dcs" class="level3">
<h3 class="anchored" data-anchor-id="all_dcs">all_dcs</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> all_dcs(</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    db, with_views:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, store:<span class="bu">bool</span><span class="op">=</span><span class="va">True</span>, suf:<span class="bu">str</span><span class="op">=</span><span class="st">''</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>dataclasses for all objects in <code>db</code></em></p>
</section>
</section>
<section id="get" class="level2">
<h2 class="anchored" data-anchor-id="get">get</h2>
<p>The <code>xtra</code> method (defined earlier) lets you set persistent filters on a table. The <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#_add_xtra"><code>_add_xtra</code></a> helper injects these constraints into WHERE clauses. This is useful for multi-tenant apps or any situation where you want automatic row filtering — e.g., <code>album.xtra(artist_id=1)</code> ensures all subsequent queries only see albums by artist 1.</p>
<p><code>__getitem__</code> provides dict-style access by primary key. It raises <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#notfounderror"><code>NotFoundError</code></a> if the row doesn’t exist (or doesn’t match <code>xtra</code> constraints). If a dataclass has been generated for the table, results are automatically converted to that type.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L314" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="table.__getitem__" class="level3">
<h3 class="anchored" data-anchor-id="table.__getitem__">Table.__getitem__</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__getitem__</span>(</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>    pk</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Get row by primary key, raising NotFoundError if missing</em></p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L311" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="notfounderror" class="level3">
<h3 class="anchored" data-anchor-id="notfounderror">NotFoundError</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> NotFoundError(</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Common base class for all non-exit exceptions.</em></p>
<div id="202afd28" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> <span class="cf">await</span> artist[<span class="dv">1</span>]</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>a</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Artist(artist_id=1, name='AC/DC')</code></pre>
</div>
</div>
<div id="4017f29c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>a._db</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;__main__.Database&gt;</code></pre>
</div>
</div>
<div id="e2ffa020" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>album <span class="op">=</span> dt.album</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>Album <span class="op">=</span> album.dataclass()</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Album 1:"</span>, <span class="cf">await</span> album[<span class="dv">1</span>])</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Artist ID of album 1:"</span>, (<span class="cf">await</span> album[<span class="dv">1</span>]).artist_id)</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>album.xtra(artist_id<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">With xtra(artist_id=1):"</span>)</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Album 1:"</span>, <span class="cf">await</span> album[<span class="dv">1</span>])  <span class="co"># Should work - album 1 is by artist 1</span></span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>: <span class="cf">await</span> album[<span class="dv">2</span>]  <span class="co"># Album 2 is by a different artist</span></span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> NotFoundError <span class="im">as</span> e: <span class="bu">print</span>(<span class="st">'Error correctly raised:'</span>, <span class="bu">type</span>(e))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Album 1: Album(album_id=1, title='For Those About To Rock We Salute You', artist_id=1)
Artist ID of album 1: 1

With xtra(artist_id=1):
Album 1: Album(album_id=1, title='For Those About To Rock We Salute You', artist_id=1)
Error correctly raised: &lt;class '__main__.NotFoundError'&gt;</code></pre>
</div>
</div>
<p><code>get</code> is the “safe” version of <code>__getitem__</code> — it returns <code>None</code> instead of raising an exception when a row isn’t found. This mirrors the pattern in fastlite and Python’s <code>dict.get()</code>.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L322" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="table.get" class="level3">
<h3 class="anchored" data-anchor-id="table.get">Table.get</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get(</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>    pk</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Get row by primary key, or None if missing</em></p>
<div id="641fdad5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> artist.get(<span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Artist(artist_id=1, name='AC/DC')</code></pre>
</div>
</div>
<div id="46e8e9ff" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> artist.get(<span class="dv">99999</span>)  <span class="co"># Should return None</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="callselect" class="level2">
<h2 class="anchored" data-anchor-id="callselect">call/select</h2>
<p><code>rows_where</code> is the core query method. It builds SQL from its parameters, applies <code>xtra</code> constraints, and optionally converts results to the table’s dataclass. Unlike psycopg2/sqlite which use <code>?</code> placeholders, PostgreSQL uses <code>$1, $2</code> positional parameters.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L329" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="table.rows_where" class="level3">
<h3 class="anchored" data-anchor-id="table.rows_where">Table.rows_where</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rows_where(</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>    where:NoneType<span class="op">=</span><span class="va">None</span>, where_args:NoneType<span class="op">=</span><span class="va">None</span>, order_by:NoneType<span class="op">=</span><span class="va">None</span>, select:<span class="bu">str</span><span class="op">=</span><span class="st">'*'</span>, limit:NoneType<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    offset:NoneType<span class="op">=</span><span class="va">None</span>, as_cls:<span class="bu">bool</span><span class="op">=</span><span class="va">True</span>, debug:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Iterate over rows matching where clause</em></p>
<div id="f687fb9e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> artist.rows_where(limit<span class="op">=</span><span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[Artist(artist_id=1, name='AC/DC'),
 Artist(artist_id=2, name='Accept'),
 Artist(artist_id=3, name='Aerosmith')]</code></pre>
</div>
</div>
<div id="c1c8036e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>album.xtra(artist_id<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> album.rows_where(limit<span class="op">=</span><span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[Album(album_id=1, title='For Those About To Rock We Salute You', artist_id=1),
 Album(album_id=4, title='Let There Be Rock', artist_id=1)]</code></pre>
</div>
</div>
<p><code>count</code> is an async property that returns the number of rows in a table. It respects <code>xtra</code> constraints, so if you’ve set filters, only matching rows are counted:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L344" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="table.count_where" class="level3">
<h3 class="anchored" data-anchor-id="table.count_where">Table.count_where</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_where(</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    where:NoneType<span class="op">=</span><span class="va">None</span>, where_args:NoneType<span class="op">=</span><span class="va">None</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L352" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="table.count" class="level3">
<h3 class="anchored" data-anchor-id="table.count">Table.count</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count(</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="dfc81515" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>album.xtra(artist_id<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> album.count</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>2</code></pre>
</div>
</div>
<div id="a7e8875e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>album.xtra()</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> album.count</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>347</code></pre>
</div>
</div>
<p><a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#get_field"><code>get_field</code></a> extracts a value from either a dict-like object (using <code>[k]</code>) or a dataclass/object (using <code>getattr</code>). This lets us handle both <code>Record</code> and dataclass results uniformly:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L358" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_field" class="level3">
<h3 class="anchored" data-anchor-id="get_field">get_field</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_field(</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>    r, k</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><code>pks_and_rows_where</code> wraps <code>rows_where</code> but returns <code>(pk, row)</code> tuples — useful when you need to know which primary key each row has without inspecting the row itself.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L363" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="table.pks_and_rows_where" class="level3">
<h3 class="anchored" data-anchor-id="table.pks_and_rows_where">Table.pks_and_rows_where</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pks_and_rows_where(</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>    kwargs:VAR_KEYWORD</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Like rows_where but returns (pk, row) tuples</em></p>
<div id="d53966b9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> artist.pks_and_rows_where(limit<span class="op">=</span><span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[(1, Artist(artist_id=1, name='AC/DC')),
 (2, Artist(artist_id=2, name='Accept')),
 (3, Artist(artist_id=3, name='Aerosmith'))]</code></pre>
</div>
</div>
<p><code>__call__</code> makes tables callable, providing a convenient shorthand for queries. <code>await artist(limit=3)</code> is equivalent to <code>await artist.rows_where(limit=3)</code>. The <code>with_pk</code> parameter switches to returning <code>(pk, row)</code> tuples.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L371" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="table.__call__" class="level3">
<h3 class="anchored" data-anchor-id="table.__call__">Table.__call__</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__call__</span>(</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>    where:NoneType<span class="op">=</span><span class="va">None</span>, where_args:NoneType<span class="op">=</span><span class="va">None</span>, order_by:NoneType<span class="op">=</span><span class="va">None</span>, limit:NoneType<span class="op">=</span><span class="va">None</span>, offset:NoneType<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>    select:<span class="bu">str</span><span class="op">=</span><span class="st">'*'</span>, with_pk:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, as_cls:<span class="bu">bool</span><span class="op">=</span><span class="va">True</span>, debug:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Query table rows</em></p>
<div id="f360b315" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> artist(limit<span class="op">=</span><span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[Artist(artist_id=1, name='AC/DC'),
 Artist(artist_id=2, name='Accept'),
 Artist(artist_id=3, name='Aerosmith')]</code></pre>
</div>
</div>
<div id="a28cacc3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> artist(limit<span class="op">=</span><span class="dv">3</span>, with_pk<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[(1, Artist(artist_id=1, name='AC/DC')),
 (2, Artist(artist_id=2, name='Accept')),
 (3, Artist(artist_id=3, name='Aerosmith'))]</code></pre>
</div>
</div>
<div id="3d59e239" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>album.xtra(artist_id<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> album(limit<span class="op">=</span><span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[Album(album_id=1, title='For Those About To Rock We Salute You', artist_id=1),
 Album(album_id=4, title='Let There Be Rock', artist_id=1)]</code></pre>
</div>
</div>
<p><code>selectone</code> returns exactly one row matching the query, raising <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#notfounderror"><code>NotFoundError</code></a> if none found or <code>ValueError</code> if multiple found. It passes <code>limit=2</code> internally so it can detect the “not unique” case without fetching the entire table.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L380" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="table.selectone" class="level3">
<h3 class="anchored" data-anchor-id="table.selectone">Table.selectone</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> selectone(</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>    where:<span class="bu">str</span> <span class="op">|</span> <span class="va">None</span><span class="op">=</span><span class="va">None</span>, <span class="co"># SQL where fragment to use, for example `id &gt; ?`</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>    where_args:Union<span class="op">=</span><span class="va">None</span>, <span class="co"># Parameters to use with `where`; iterable for `id&gt;?`, or dict for `id&gt;:id`</span></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>    select:<span class="bu">str</span><span class="op">=</span><span class="st">'*'</span>, <span class="co"># Comma-separated list of columns to select</span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>    as_cls:<span class="bu">bool</span><span class="op">=</span><span class="va">True</span>, <span class="co"># Convert returned dict to stored dataclass?</span></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>    debug:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span></span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span><span class="bu">list</span>:</span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Shortcut for <code>__call__</code> that returns exactly one item</em></p>
<div id="060ff595" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> artist.selectone(<span class="st">'Name=$1'</span>, (<span class="st">'AC/DC'</span>,), debug<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>SELECT * FROM "artist" WHERE Name=$1 LIMIT 2</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Artist(artist_id=1, name='AC/DC')</code></pre>
</div>
</div>
<div id="a2de93ed" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>: <span class="cf">await</span> artist.selectone(<span class="st">'Name like $1'</span>, (<span class="st">'%a%'</span>,))</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ValueError</span>: <span class="cf">pass</span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>: <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">"Failed to get non unique exception"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6911c60e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>: <span class="cf">await</span> artist.selectone(<span class="st">'Name=$1'</span>, (<span class="st">'i do not exist'</span>,))</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> NotFoundError: <span class="cf">pass</span></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>: <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">"Failed to get NotFoundError"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><code>db.item</code> is for scalar queries — it returns a single field from a single row. Useful for things like <code>SELECT count(*)</code> or <code>SELECT max(price)</code>.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L396" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="database.item" class="level3">
<h3 class="anchored" data-anchor-id="database.item">Database.item</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> item(</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>    sql, args:NoneType<span class="op">=</span><span class="va">None</span></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Execute sql and return a single field from a single row</em></p>
<div id="676c3a7a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> db.item(<span class="st">'select artist_id from artist where name=$1'</span>, (<span class="st">'AC/DC'</span>,))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>1</code></pre>
</div>
</div>
</section>
</section>
<section id="create_mod" class="level2">
<h2 class="anchored" data-anchor-id="create_mod">create_mod</h2>
<p><a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#create_mod"><code>create_mod</code></a> generates a Python module file containing dataclass definitions for all tables in the database. This lets you import type-checked dataclasses directly rather than regenerating them each time. The generated file includes proper imports and uses <code>UNSET</code> defaults for flexible instantiation.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L406" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="create_mod-1" class="level3">
<h3 class="anchored" data-anchor-id="create_mod-1">create_mod</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_mod(</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>    db, mod_fn, with_views:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, store:<span class="bu">bool</span><span class="op">=</span><span class="va">True</span>, suf:<span class="bu">str</span><span class="op">=</span><span class="st">''</span></span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Create module for dataclasses for <code>db</code></em></p>
<div id="f4ce5d36" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>create_mod(db, <span class="st">'db_dc'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><code>link_dcs</code> reconnects a database’s tables to dataclasses from a previously generated module. This is useful when you’ve imported dataclasses from a file created by <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#create_mod"><code>create_mod</code></a> and want the ORM to use them.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L422" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="database.link_dcs" class="level3">
<h3 class="anchored" data-anchor-id="database.link_dcs">Database.link_dcs</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> link_dcs(</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>    mod</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Set the internal dataclass type links for tables using <code>mod</code> (created via <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#create_mod"><code>create_mod</code></a>)</em></p>
<div id="053ee2df" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> db_dc <span class="im">import</span> <span class="op">*</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> dt.track[<span class="dv">1</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Track(track_id=1, name='For Those About To Rock (We Salute You)', album_id=1, media_type_id=1, genre_id=1, composer='Angus Young, Malcolm Young, Brian Johnson', milliseconds=343719, bytes=11170334, unit_price=Decimal('0.99'))</code></pre>
</div>
</div>
<p><code>set_classes</code> is a convenience method that links all table dataclasses from a namespace (typically <code>globals()</code>). It expects dataclass names to be title-cased versions of table names (e.g., <code>Artist</code> for table <code>artist</code>).</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L428" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="database.set_classes" class="level3">
<h3 class="anchored" data-anchor-id="database.set_classes">Database.set_classes</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> set_classes(</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>    glb</span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Add set all table dataclasses using types in namespace <code>glb</code></em></p>
<div id="1080f615" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>db.t</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>artist, album, employee, customer, invoice, invoice_line, track, playlist, playlist_track, genre, media_type, cats, cat, dog</code></pre>
</div>
</div>
<p><code>get_tables</code> injects table objects into a namespace with pluralized names — so <code>db.t.album</code> becomes available as <code>albums</code>. Combined with <code>set_classes</code>, this gives you a clean API: <code>await albums(limit=3)</code> returns a list of <code>Album</code> dataclass instances.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L434" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="database.get_tables" class="level3">
<h3 class="anchored" data-anchor-id="database.get_tables">Database.get_tables</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_tables(</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>    glb</span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Add objects for all table objects to namespace <code>glb</code></em></p>
<div id="0ab4c3f5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>db.set_classes(<span class="bu">globals</span>())</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>db.get_tables(<span class="bu">globals</span>())</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> albums(limit<span class="op">=</span><span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[Album(album_id=1, title='For Those About To Rock We Salute You', artist_id=1)]</code></pre>
</div>
</div>
<div id="9b4722af" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> employees(limit<span class="op">=</span><span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[Employee(employee_id=1, last_name='Adams', first_name='Andrew', title='General Manager', reports_to=None, birth_date=datetime.datetime(1962, 2, 18, 0, 0), hire_date=datetime.datetime(2002, 8, 14, 0, 0), address='11120 Jasper Ave NW', city='Edmonton', state='AB', country='Canada', postal_code='T5K 2N1', phone='+1 (780) 428-9482', fax='+1 (780) 428-3457', email='andrew@chinookcorp.com')]</code></pre>
</div>
</div>
</section>
</section>
<section id="insert" class="level2">
<h2 class="anchored" data-anchor-id="insert">insert</h2>
<p>To support both dataclasses and dicts as input, and to handle <code>Enum</code> values properly, we need these imports:</p>
<p><a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#_process_row"><code>_process_row</code></a> converts a dataclass (or dict) to a plain dict, filtering out <code>UNSET</code> values and extracting <code>.value</code> from Enum fields. This lets you pass partially-filled dataclasses to <code>insert</code>/<code>update</code>.</p>
<p><code>insert</code> adds a row to the table. It accepts either a dataclass/dict as <code>record</code>, keyword arguments, or both (kwargs override record fields). PostgreSQL’s <code>RETURNING *</code> clause lets us get the inserted row back in one query — including any auto-generated values like <code>SERIAL</code> primary keys. The <code>xtra</code> constraints are automatically merged in.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L458" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="table.insert" class="level3">
<h3 class="anchored" data-anchor-id="table.insert">Table.insert</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb166"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> insert(</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>    record:NoneType<span class="op">=</span><span class="va">None</span>, kwargs:VAR_KEYWORD</span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Insert a row and return it</em></p>
<p>For DDL statements like <code>CREATE TABLE</code>, use <code>execute</code> rather than <code>fetch</code>/<code>q</code>. DDL statements don’t return rows — they return a status string like <code>'CREATE TABLE'</code>. PostgreSQL uses <code>SERIAL</code> for auto-incrementing integers (instead of SQLite’s <code>INTEGER PRIMARY KEY</code>) and <code>REAL</code> instead of <code>FLOAT</code>.</p>
<div id="e56b97ea" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> db.execute(<span class="st">'''</span></span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a><span class="st">DROP TABLE IF EXISTS cat;</span></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a><span class="st">CREATE TABLE cat (</span></span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a><span class="st">    id SERIAL PRIMARY KEY,</span></span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a><span class="st">    name TEXT,</span></span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a><span class="st">    weight REAL,</span></span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a><span class="st">    uid INTEGER</span></span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a><span class="st">)'''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'CREATE TABLE'</code></pre>
</div>
</div>
<p><code>_retr_tbl</code> is a helper that refreshes the database metadata and returns the table object for a given name. This ensures you’re working with up-to-date schema information after creating or modifying tables.</p>
<p><code>table2glb</code> is a convenience method that refreshes metadata, creates the dataclass, and injects both the table object (pluralized name) and the dataclass into a namespace. This is handy after creating a new table.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L476" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="database.table2glb" class="level3">
<h3 class="anchored" data-anchor-id="database.table2glb">Database.table2glb</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> table2glb(</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>    name, glb:NoneType<span class="op">=</span><span class="va">None</span></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Get table by name, refreshing metadata and creating dataclass, adding to glb</em></p>
<div id="14f5b218" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> db.table2glb(<span class="st">'cat'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cec63e22" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>cats</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Table "cat"</code></pre>
</div>
</div>
<div id="52d423ef" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb173"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> <span class="cf">await</span> cats.insert(name<span class="op">=</span><span class="st">'meow'</span>, weight<span class="op">=</span><span class="dv">6</span>, uid<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a>c</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Cat(id=1, name='meow', weight=6.0, uid=2)</code></pre>
</div>
</div>
<div id="302bb461" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> cats()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[Cat(id=1, name='meow', weight=6.0, uid=2)]</code></pre>
</div>
</div>
<p>With <code>xtra</code> set, <code>insert</code> automatically includes those constraints. Here we set <code>uid=1</code>, so the inserted cat gets that value even though we didn’t pass it explicitly.</p>
<div id="15d37142" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb177"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>cats.xtra(uid<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>c2 <span class="op">=</span> <span class="cf">await</span> cats.insert(name<span class="op">=</span><span class="st">'purr'</span>, weight<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>c2</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Cat(id=2, name='purr', weight=4.0, uid=1)</code></pre>
</div>
</div>
<div id="914655a4" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> cats()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[Cat(id=2, name='purr', weight=4.0, uid=1)]</code></pre>
</div>
</div>
<p>Calling <code>xtra()</code> with no arguments clears the filter by setting <code>xtra_id = {}</code>. Now queries return all rows again.</p>
<div id="55b3f72f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb181"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>cats.xtra()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Table "cat"</code></pre>
</div>
</div>
<div id="9aad2f74" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb183"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> cats()  <span class="co"># Should now return all cats, not just uid=1</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[Cat(id=1, name='meow', weight=6.0, uid=2),
 Cat(id=2, name='purr', weight=4.0, uid=1)]</code></pre>
</div>
</div>
</section>
</section>
<section id="update" class="level2">
<h2 class="anchored" data-anchor-id="update">update</h2>
<div id="dcee68af" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb185"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>c.name <span class="op">=</span> <span class="st">"moo"</span></span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>c.uid <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>c</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Cat(id=1, name='moo', weight=6.0, uid=1)</code></pre>
</div>
</div>
<p><a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#_pk_where"><code>_pk_where</code></a> builds a WHERE clause for primary key matching, using PostgreSQL’s <code>$1, $2</code> placeholders with an offset to account for preceding parameters in the query.</p>
<p><code>update</code> modifies an existing row by primary key. It builds an <code>UPDATE ... SET ... WHERE pk = $n RETURNING *</code> statement. Like <code>insert</code>, it respects <code>xtra</code> constraints — if you try to update a row that doesn’t match the <code>xtra</code> filter, you’ll get <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#notfounderror"><code>NotFoundError</code></a>.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L489" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="table.update" class="level3">
<h3 class="anchored" data-anchor-id="table.update">Table.update</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb187"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> update(</span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>    record:NoneType<span class="op">=</span><span class="va">None</span>, pk_values:NoneType<span class="op">=</span><span class="va">None</span>, kwargs:VAR_KEYWORD</span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Update a row and return it</em></p>
<div id="5bba56f2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> cats.update(c)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Cat(id=1, name='moo', weight=6.0, uid=1)</code></pre>
</div>
</div>
<div id="bf5b2543" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> cats()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[Cat(id=2, name='purr', weight=4.0, uid=1),
 Cat(id=1, name='moo', weight=6.0, uid=1)]</code></pre>
</div>
</div>
<div id="d3202757" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>cats.xtra(uid<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>c.uid <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>: <span class="cf">await</span> cats.update(c)  <span class="co"># Should fail - c has id=1 which has uid=1, not uid=2</span></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> NotFoundError <span class="im">as</span> e: <span class="bu">print</span>(<span class="st">'Correctly blocked:'</span>, e)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Correctly blocked: cat[[1, 2]]</code></pre>
</div>
</div>
<div id="faf46a30" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>cats.xtra()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Table "cat"</code></pre>
</div>
</div>
</section>
</section>
<section id="delete" class="level2">
<h2 class="anchored" data-anchor-id="delete">delete</h2>
<p><code>delete</code> removes a row by primary key, returning the deleted row (using <code>RETURNING *</code>). Like the other methods, it respects <code>xtra</code> constraints — attempting to delete a row that doesn’t match the filter raises <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#notfounderror"><code>NotFoundError</code></a>.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L502" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="table.delete" class="level3">
<h3 class="anchored" data-anchor-id="table.delete">Table.delete</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb196"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> delete(</span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a>    pk_values</span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Delete row by primary key, returning the deleted row</em></p>
<p>Let’s verify delete works — first check what cats we have:</p>
<div id="c8acfcde" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb197"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> cats()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[Cat(id=2, name='purr', weight=4.0, uid=1),
 Cat(id=1, name='moo', weight=6.0, uid=1)]</code></pre>
</div>
</div>
<p>Delete returns the deleted row, so you can see exactly what was removed:</p>
<div id="2dde9a9a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> cats.delete(c.<span class="bu">id</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Cat(id=1, name='moo', weight=6.0, uid=1)</code></pre>
</div>
</div>
<div id="1e7201a7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> cats()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[Cat(id=2, name='purr', weight=4.0, uid=1)]</code></pre>
</div>
</div>
<p>The <code>xtra</code> filter also applies to deletes. If you try to delete a row that doesn’t match the constraint, you get <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#notfounderror"><code>NotFoundError</code></a>:</p>
<div id="e7f576eb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>cats.xtra(uid<span class="op">=</span><span class="dv">99</span>)</span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>: <span class="cf">await</span> cats.delete(<span class="dv">2</span>)  <span class="co"># Should fail - cat 2 has uid=1, not uid=99</span></span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> NotFoundError <span class="im">as</span> e: <span class="bu">print</span>(<span class="st">'Correctly blocked:'</span>, e)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Correctly blocked: cat[2]</code></pre>
</div>
</div>
<div id="a8fa5ea2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>cats.xtra()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Table "cat"</code></pre>
</div>
</div>
<p><code>delete_where</code> is the bulk version of <code>delete</code> — it removes all rows matching a WHERE clause (or all rows if none given), returning the deleted rows as a list. Like <code>delete</code>, it respects <code>xtra</code> constraints and uses <code>RETURNING *</code> to give back what was removed. This is useful for cleanup operations like removing all rows above a threshold.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L510" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="table.delete_where" class="level3">
<h3 class="anchored" data-anchor-id="table.delete_where">Table.delete_where</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> delete_where(</span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a>    where:NoneType<span class="op">=</span><span class="va">None</span>, where_args:NoneType<span class="op">=</span><span class="va">None</span></span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="322fa8c8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb208"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> cats.insert(name<span class="op">=</span><span class="st">'Cat McCat Face'</span>, weight<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> cats.insert(name<span class="op">=</span><span class="st">'Skitter'</span>, weight<span class="op">=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Cat(id=4, name='Skitter', weight=2.0, uid=None)</code></pre>
</div>
</div>
<div id="e6958ba7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb210"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> cats.delete_where(<span class="st">'weight &gt; $1'</span>, [<span class="dv">3</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[Cat(id=2, name='purr', weight=4.0, uid=1),
 Cat(id=3, name='Cat McCat Face', weight=9.0, uid=None)]</code></pre>
</div>
</div>
<div id="0441bc4e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb212"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> cats()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[Cat(id=4, name='Skitter', weight=2.0, uid=None)]</code></pre>
</div>
</div>
</section>
</section>
<section id="create" class="level2">
<h2 class="anchored" data-anchor-id="create">Create</h2>
<p>To create tables from Python classes, we need a reverse mapping from Python types to PostgreSQL types. We generate it from <code>pg_to_py</code> and override some entries for cleaner defaults (e.g., <code>TEXT</code> instead of <code>character varying</code>).</p>
<p><a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#col_def"><code>col_def</code></a> builds a column definition for <code>CREATE TABLE</code>. If the column is the primary key and has type <code>int</code>, it becomes <code>SERIAL PRIMARY KEY</code> (PostgreSQL’s auto-incrementing integer). Otherwise it maps the Python type to PostgreSQL and adds <code>NOT NULL</code> if specified.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L521" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="col_def" class="level3">
<h3 class="anchored" data-anchor-id="col_def">col_def</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb214"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> col_def(</span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a>    name, typ, pk, not_null</span>
<span id="cb214-4"><a href="#cb214-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb214-5"><a href="#cb214-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Build column definition SQL for CREATE TABLE</em></p>
<div id="5c32920f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb215"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a>col_def(<span class="st">'id'</span>, <span class="bu">int</span>, <span class="st">'id'</span>, <span class="va">None</span>)  <span class="co"># 'id' is pk and int -&gt; SERIAL PRIMARY KEY</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'"id" SERIAL PRIMARY KEY'</code></pre>
</div>
</div>
<div id="505042da" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb217"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a>col_def(<span class="st">'name'</span>, <span class="bu">str</span>, <span class="st">'id'</span>, {<span class="st">'name'</span>})  <span class="co"># not pk, in not_null -&gt; TEXT NOT NULL</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'"name" TEXT NOT NULL'</code></pre>
</div>
</div>
<div id="b8529c9c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb219"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a>col_def(<span class="st">'age'</span>, <span class="bu">int</span>, <span class="st">'id'</span>, <span class="va">None</span>)  <span class="co"># not pk -&gt; INTEGER</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'"age" INTEGER'</code></pre>
</div>
</div>
<p><code>db.create</code> creates a table from a Python class (or dataclass). It extracts field names and types, builds column definitions, and executes the <code>CREATE TABLE</code> statement. The <code>replace=True</code> option drops any existing table first (with <code>CASCADE</code> to handle dependencies).</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L532" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="database.create" class="level3">
<h3 class="anchored" data-anchor-id="database.create">Database.create</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb221"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create(</span>
<span id="cb221-3"><a href="#cb221-3" aria-hidden="true" tabindex="-1"></a>    cls:NoneType<span class="op">=</span><span class="va">None</span>, name:NoneType<span class="op">=</span><span class="va">None</span>, pk:<span class="bu">str</span><span class="op">=</span><span class="st">'id'</span>, foreign_keys:NoneType<span class="op">=</span><span class="va">None</span>, defaults:NoneType<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb221-4"><a href="#cb221-4" aria-hidden="true" tabindex="-1"></a>    column_order:NoneType<span class="op">=</span><span class="va">None</span>, not_null:NoneType<span class="op">=</span><span class="va">None</span>, if_not_exists:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, replace:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span></span>
<span id="cb221-5"><a href="#cb221-5" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb221-6"><a href="#cb221-6" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Create table from <code>cls</code></em></p>
<p><code>drop</code> removes a table from the database. The <code>cascade=True</code> option also drops any dependent objects (like foreign key references from other tables).</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L558" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="table.drop" class="level3">
<h3 class="anchored" data-anchor-id="table.drop">Table.drop</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb222"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> drop(</span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a>    cascade:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span></span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb222-5"><a href="#cb222-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Drop this table</em></p>
<div id="f2db9b85" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb223"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> db.t.dog.drop(cascade<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now let’s test <code>create</code> with a simple <code>Dog</code> class:</p>
<div id="c4580dd1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb224"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Dog: <span class="bu">id</span>:<span class="bu">int</span><span class="op">;</span> name:<span class="bu">str</span><span class="op">;</span> age:<span class="bu">int</span></span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-3"><a href="#cb224-3" aria-hidden="true" tabindex="-1"></a>dogs <span class="op">=</span> <span class="cf">await</span> db.create(Dog, replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb224-4"><a href="#cb224-4" aria-hidden="true" tabindex="-1"></a>dogs.cols</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'id': 'integer', 'name': 'text', 'age': 'integer'}</code></pre>
</div>
</div>
<p>The auto-generated <code>SERIAL</code> primary key handles auto-increment automatically:</p>
<div id="528fc71a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb226"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> <span class="cf">await</span> dogs.insert(name<span class="op">=</span><span class="st">'Rex'</span>, age<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a>d</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Dog(id=1, name='Rex', age=5)</code></pre>
</div>
</div>
<p>Foreign keys are specified as a dict mapping column names to <code>(table, column)</code> tuples:</p>
<div id="331598d7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb228"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Toy: <span class="bu">id</span>:<span class="bu">int</span><span class="op">;</span> name:<span class="bu">str</span><span class="op">;</span> dog_id:<span class="bu">int</span></span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a>toys <span class="op">=</span> <span class="cf">await</span> db.create(Toy, replace<span class="op">=</span><span class="va">True</span>, foreign_keys<span class="op">=</span>{<span class="st">'dog_id'</span>: (<span class="st">'dog'</span>, <span class="st">'id'</span>)})</span>
<span id="cb228-4"><a href="#cb228-4" aria-hidden="true" tabindex="-1"></a>toys.cols</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'id': 'integer', 'name': 'text', 'dog_id': 'integer'}</code></pre>
</div>
</div>
<p>The foreign key constraint is enforced by PostgreSQL — inserting a toy with an invalid <code>dog_id</code> would raise an error:</p>
<div id="8233069a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb230"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> <span class="cf">await</span> toys.insert(name<span class="op">=</span><span class="st">'Ball'</span>, dog_id<span class="op">=</span>d.<span class="bu">id</span>)</span>
<span id="cb230-2"><a href="#cb230-2" aria-hidden="true" tabindex="-1"></a>t</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Toy(id=1, name='Ball', dog_id=1)</code></pre>
</div>
</div>
</section>
</section>
<section id="upsert" class="level2">
<h2 class="anchored" data-anchor-id="upsert">Upsert</h2>
<p><code>upsert</code> performs an “insert or update” operation using PostgreSQL’s <code>ON CONFLICT ... DO UPDATE</code> clause. If a row with the same primary key exists, it updates it; otherwise it inserts a new row. Like <code>insert</code>, it uses <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#_prep_row"><code>_prep_row</code></a> for row processing and <code>_exec_returning</code> for result handling, and respects <code>xtra</code> constraints.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L566" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="table.upsert" class="level3">
<h3 class="anchored" data-anchor-id="table.upsert">Table.upsert</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb232"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> upsert(</span>
<span id="cb232-3"><a href="#cb232-3" aria-hidden="true" tabindex="-1"></a>    record:NoneType<span class="op">=</span><span class="va">None</span>, kwargs:VAR_KEYWORD</span>
<span id="cb232-4"><a href="#cb232-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb232-5"><a href="#cb232-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Insert or update a row and return it</em></p>
<p>Let’s test upsert — first check current state:</p>
<div id="c1f98f07" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb233"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> dogs()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[Dog(id=1, name='Rex', age=5)]</code></pre>
</div>
</div>
<p>Updating an existing row — change Rex’s age from 5 to 6:</p>
<div id="82b806be" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb235"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a>d.age <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> dogs.upsert(d)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Dog(id=1, name='Rex', age=6)</code></pre>
</div>
</div>
<div id="f2c837ef" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb237"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> dogs()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[Dog(id=1, name='Rex', age=6)]</code></pre>
</div>
</div>
<p>Inserting a new row — upsert without an existing id creates a new record:</p>
<div id="50fd4cd7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb239"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> dogs.upsert(name<span class="op">=</span><span class="st">'Spot'</span>, age<span class="op">=</span><span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Dog(id=2, name='Spot', age=3)</code></pre>
</div>
</div>
<div id="7d28bffd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb241"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> dogs()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[Dog(id=1, name='Rex', age=6), Dog(id=2, name='Spot', age=3)]</code></pre>
</div>
</div>
<p>With <code>xtra</code> set, upsert merges those constraints into the row:</p>
<div id="4d84cdd6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb243"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a>dogs.xtra(age<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a>d.name <span class="op">=</span> <span class="st">'Rexy'</span></span>
<span id="cb243-3"><a href="#cb243-3" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> dogs.upsert(d)  <span class="co"># Should set age=6 from xtra</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Dog(id=1, name='Rexy', age=6)</code></pre>
</div>
</div>
</section>
</section>
<section id="connection-pool" class="level2">
<h2 class="anchored" data-anchor-id="connection-pool">Connection pool</h2>
<p>For production use, you’ll want a connection pool instead of a single connection. <code>asyncpg.Pool</code> has the same query methods (<code>fetch</code>, <code>execute</code>, etc.) as a connection, so our <a href="https://AnswerDotAI.github.io/fastasyncpg/core.html#database"><code>Database</code></a> wrapper works with both. The key difference is that JSON codecs must be registered via the <code>init</code> callback (which runs on each new connection in the pool).</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/fastasyncpg/blob/main/fastasyncpg/core.py#L575" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="create_pool" class="level3">
<h3 class="anchored" data-anchor-id="create_pool">create_pool</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb245"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-2"><a href="#cb245-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_pool(</span>
<span id="cb245-3"><a href="#cb245-3" aria-hidden="true" tabindex="-1"></a>    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD</span>
<span id="cb245-4"><a href="#cb245-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb245-5"><a href="#cb245-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="d5611a7f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb246"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> db.close()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Let’s test that the pool works the same as a single connection:</p>
<div id="79c5353d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb247"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> <span class="cf">await</span> create_pool(user<span class="op">=</span>user, database<span class="op">=</span><span class="st">'chinook'</span>, host<span class="op">=</span><span class="st">'127.0.0.1'</span>)</span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> db.t.artist(limit<span class="op">=</span><span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[&lt;FRecord artist_id=1 name='AC/DC'&gt;,
 &lt;FRecord artist_id=2 name='Accept'&gt;,
 &lt;FRecord artist_id=3 name='Aerosmith'&gt;]</code></pre>
</div>
</div>
<div id="49fc19b8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb249"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="bu">str</span>(db)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'postgresql://jhoward@127.0.0.1:5432/chinook'</code></pre>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/AnswerDotAI\.github\.io\/fastasyncpg");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/AnswerDotAI/fastasyncpg/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>